<!DOCTYPE html>
<html>
    <head>
    <!-- Title -->
    
    <title>
        Webpack Tree-shaking-loader 的基本实现 | JackerJay杂记
    </title>
    
    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">
    
    <!-- Meta & INfo -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="JackerJay">
    <meta name="description" content="学习成长路">
    <meta name="keywords" content="null">
    
    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">
    
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="JackerJay杂记">
    
    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://jackerjay.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Webpack Tree-shaking-loader 的基本实现 | JackerJay杂记">
    <meta property="og:description" content="学习成长路">
    
     <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">
        
        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->
    
    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
	body, html{
		font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
	}
	
    a{
        color: #00838F
    }
    
    .mdl-card__media,
    #search-label,
    #search-form-label:after,
    #scheme-Paradox .hot_tags-count,
    #scheme-Paradox .sidebar_archives-count,
    #scheme-Paradox .sidebar-colored .sidebar-header,
    #scheme-Paradox .sidebar-colored .sidebar-badge{
        background-color: #0097A7 !important
    }
    
	/* Sidebar User Drop Down Menu Text Color */
	#scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
    #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus{
        color: #0097A7 !important
    }
    
    #post_entry-right-info,
    .sidebar-colored .sidebar-nav li:hover > a,
    .sidebar-colored .sidebar-nav li:hover > a i,
    .sidebar-colored .sidebar-nav li > a:hover,
    .sidebar-colored .sidebar-nav li > a:hover i,
    .sidebar-colored .sidebar-nav li > a:focus i,
    .sidebar-colored .sidebar-nav > .open > a,
    .sidebar-colored .sidebar-nav > .open > a:hover,
    .sidebar-colored .sidebar-nav > .open > a:focus,
    #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a{
        color: #0097A7 !important
    }
    
    .toTop{
        background: #757575 !important
    }
		
	.material-layout .material-post>.material-nav,
	.material-layout .material-index>.material-nav,
	.material-nav a{
		color: #757575;
	}
		
	#scheme-Paradox .MD-burger-layer {
		background-color: #757575;
	}

	#scheme-Paradox #post-toc-trigger-btn{
		color: #757575;
	}
	
	.post-toc a:hover{
		color: #00838F;
		text-decoration: underline;
	}
</style>


<!-- Theme Background Related-->

    <style>
        body{
            background-color: #F5F5F5
        }
		
		/* blog_info bottom background */
        #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
            background-color: #fff;
        }
    </style>




<!-- Fade Effect -->

    <style>
        .fade {
            transition: all 800ms linear;
            -webkit-transform: translate3d(0,0,0);
            -moz-transform: translate3d(0,0,0);
            -ms-transform: translate3d(0,0,0);
            -o-transform: translate3d(0,0,0);
            transform: translate3d(0,0,0);
            opacity: 1;
        }

        .fade.out{
            opacity: 0;
        }
    </style>

	<script src="/js/jquery.min.js"></script>
	
	<link rel="stylesheet" href="/css/highlight/solarized-white.css">
	
	<!-- UC Browser Compatible-->
	<script>
		var agent = navigator.userAgent.toLowerCase();
		if(agent.indexOf('ucbrowser')>0) {
			document.write('<link rel="stylesheet" href="/css/uc.css">');
		   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
		}
	</script>
    <!-- Hotjar Tracking Code for http://jackerjay.cc -->
    <script>
			(function(h,o,t,j,a,r){
				h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
				h._hjSettings={hjid:478398,hjsv:5};
				a=o.getElementsByTagName('head')[0];
				r=o.createElement('script');r.async=1;
				r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
				a.appendChild(r);
			})(window,document,'//static.hotjar.com/c/hotjar-','.js?sv=');
    </script>
    
    <!-- Custom Head -->
    
</head>
	
	

    <body id="scheme-Paradox">

		
        <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
				
			
			
            <!-- Main Container -->
            <main class="material-layout__content" id="main">
				
                <!-- Top Anchor -->
                <div id="top"></div>
				
				
                <!-- Hamburger Button -->
                <button class="MD-burger-icon sidebar-toggle">
                    <span class="MD-burger-layer"></span>
                </button>
				
				
                
	<!-- Back Button -->
<!--
	<div class="material-back" id="backhome-div" tabindex="0">
		<a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" href="#" onclick="window.history.back();return false;" target="_self" role="button" data-upgraded=",MaterialButton,MaterialRipple">
			<i class="material-icons" role="presentation">arrow_back</i>
			<span class="mdl-button__ripple-container">
				<span class="mdl-ripple"></span>
			</span>
		</a>
	</div>			
-->
	<!-- Left aligned menu below button -->
	<button id="post-toc-trigger-btn"
			class="mdl-button mdl-js-button mdl-button--icon">
	  <i class="material-icons">format_list_numbered</i>
	</button>

	<ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect"
		for="post-toc-trigger-btn">
			
			<ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Wepack-Tree-shaking-loader-的基本实现"><span class="post-toc-number">1.</span> <span class="post-toc-text">Wepack Tree-shaking-loader 的基本实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#开始之前"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">开始之前</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#认识AST到底是什么样的"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">认识AST到底是什么样的</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#小栗子-ES6箭头函数转译为ES5普通函数"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">小栗子-ES6箭头函数转译为ES5普通函数</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#复杂的小栗子-class-的-ES5-转换"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">复杂的小栗子- class 的 ES5 转换</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#正文开始——-shaking"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">正文开始—— shaking</span></a></li></ol></li></ol>
		
<!--			<li class="mdl-menu__item">Some Action</li>-->
	</ul>


<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">
		
        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
	<!-- Paradox Post Header -->
	
		
			<!-- Random Thumbnail -->
			<div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
				<script>
    
    var randomNum;
    randomNum = Math.floor(Math.random() * 5 + 1);
    
    $(".post_thumbnail-random").css('background-image', 'url(' + '/img/random/' + randomNum + '.png' + ')');
    
</script>

		
	
        <p class="article-headline-p">
            Webpack Tree-shaking-loader 的基本实现
        </p>
    </div>

	

				
				
					<!-- Paradox Post Info -->
					<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
    
    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>JackerJay</strong>
        <span>7月 12, 2018</span>
    </div>
    
    <div class="section-spacer"></div>
	
    <!-- Favorite -->
<!--
    <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
        <i class="material-icons" role="presentation">favorite</i>
        <span class="visuallyhidden">favorites</span>
    </button>
-->
    
    <!-- Tags (bookmark) -->
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/babel/">babel</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/babel-plugin/">babel-plugin</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/webpack/">webpack</a>
    </ul>
    
    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    
    
    
    
    
    <!-- Share Twitter -->
    <a class="post_share-link" href="https://twitter.com/intent/tweet?text=Webpack Tree-shaking-loader 的基本实现&url=https://jackerjay.github.io//2018/07/12/Webpack-Tree-shaking-loader-的基本实现/index.html&via=JackerJay" target="_blank">
        <li class="mdl-menu__item">
            分享到 Twitter
        </li>
    </a>
    
    <!-- Share Google+ -->
    <a class="post_share-link" href="https://plus.google.com/share?url=https://jackerjay.github.io//2018/07/12/Webpack-Tree-shaking-loader-的基本实现/index.html" target="_blank">
        <li class="mdl-menu__item">
            分享到 Google+
        </li>
    </a>
    
    <!-- Share Weibo -->
    <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=Webpack Tree-shaking-loader 的基本实现&url=https://jackerjay.github.io//2018/07/12/Webpack-Tree-shaking-loader-的基本实现/index.html&pic=&searchPic=false&style=simple" target="_blank">
        <li class="mdl-menu__item">
            分享到微博
        </li>
    </a>
</ul>
</div>
				

                <!-- Post Content -->
                <div id="post-content" class="markdown-Github mdl-color-text--grey-700 mdl-card__supporting-text fade out">
	
		<h2 id="Wepack-Tree-shaking-loader-的基本实现"><a href="#Wepack-Tree-shaking-loader-的基本实现" class="headerlink" title="Wepack Tree-shaking-loader 的基本实现"></a>Wepack Tree-shaking-loader 的基本实现</h2><blockquote>
<p>本文章记录基于AST(抽象语法树)的 Tree-shaking-loader 的基本实现，内容来自于珠峰的公开课  </p>
</blockquote>
<h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><p>在开始之前，我们要了解什么是 <code>AST(abstract syntax tree)</code> 即为 <code>抽象语法树</code> ，是源代码的抽象语法结构的树状表现形式，详细信息可以参考 <a href="https://segmentfault.com/a/1190000012943992" target="_blank" rel="noopener">抽象语法树</a>。<br>在接下来实现之前，我们还需要准备几个工具和插件： </p>
<ul>
<li><a href="http://esprima.org/index.html" target="_blank" rel="noopener">esprima</a> 一个高性能的<code>ECMAScript</code>语法分析其，可以让我们直观看到源码的<code>AST</code>.  </li>
<li><a href="https://github.com/estools/escodegen" target="_blank" rel="noopener">escodegen</a> 基于<a href="https://developer.mozilla.org/zh-CN/docs/Mozilla/Projects/SpiderMonkey/Parser_API" target="_blank" rel="noopener">Mozilla’s Parser API(Mozilla的语法分析器API)</a> 的 <code>ECMAScript</code> 源代码生成工具.</li>
<li><a href="https://github.com/babel/babel/tree/master/packages/babel-core" target="_blank" rel="noopener">babel-core</a> <code>babel</code>编译器的核心代码.</li>
<li><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener">babel-types</a> <code>babel</code>的<code>AST</code>节点的方法指南工具库.</li>
<li><a href="https://webpack.js.org/" target="_blank" rel="noopener">webpack</a> 都知道的打包工具.</li>
<li><code>babel</code>的预设插件<a href="https://github.com/babel/babel-preset-env" target="_blank" rel="noopener">babel-preset-env</a> 将<code>ES6</code>转换为<code>ES5</code>的预设(已经为稳定版本，转移到<a href="https://github.com/babel/babel/tree/master/packages/babel-preset-env" target="_blank" rel="noopener">babel</a>)、<a href="https://github.com/babel/babel/tree/master/packages/babel-preset-react" target="_blank" rel="noopener">babel-preset-react</a> 所有<code>React</code>插件的<code>babel</code>预设.  </li>
<li><a href="https://github.com/babel/babel-loader" target="_blank" rel="noopener">babel-loader</a> 众所周知的<code>babel-loader</code>  </li>
<li><a href="https://ant.design/index-cn" target="_blank" rel="noopener">antd</a> 需要 shaking 的目标库<code>antd</code>  </li>
</ul>
<h3 id="认识AST到底是什么样的"><a href="#认识AST到底是什么样的" class="headerlink" title="认识AST到底是什么样的"></a>认识<code>AST</code>到底是什么样的</h3><p>我们使用<a href="http://esprima.org/index.html" target="_blank" rel="noopener">esprima</a>在线进行语法分析查看AST，诸如其给的样例：</p>
<blockquote>
<p>输入<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> answer = <span class="number">6</span> * <span class="number">7</span>;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p>输出<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Program"</span>,</span><br><span class="line">    <span class="attr">"body"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"VariableDeclaration"</span>,</span><br><span class="line">            <span class="attr">"declarations"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"VariableDeclarator"</span>,</span><br><span class="line">                    <span class="attr">"id"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"answer"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"init"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"BinaryExpression"</span>,</span><br><span class="line">                        <span class="attr">"operator"</span>: <span class="string">"*"</span>,</span><br><span class="line">                        <span class="attr">"left"</span>: &#123;</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</span><br><span class="line">                            <span class="attr">"value"</span>: <span class="number">6</span>,</span><br><span class="line">                            <span class="attr">"raw"</span>: <span class="string">"6"</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"right"</span>: &#123;</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"Literal"</span>,</span><br><span class="line">                            <span class="attr">"value"</span>: <span class="number">7</span>,</span><br><span class="line">                            <span class="attr">"raw"</span>: <span class="string">"7"</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"var"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"sourceType"</span>: <span class="string">"script"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>我们可以看得出来，源代码的 AST 其实就是一个对象，当我们去遍历 AST 的时候，会使用<strong>先序深度优先</strong>的方法进行遍历，注意：遍历只会进入到包含<code>type</code>属性的节点(node)； </p>
<p>使用以下代码进行测试：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> esprima = <span class="built_in">require</span>(<span class="string">'esprima'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`var answer = 6 * 7`</span>;</span><br><span class="line"><span class="keyword">let</span> tree = esprima.parseScript(code);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> estraverse = <span class="built_in">require</span>(<span class="string">'estraverse'</span>);</span><br><span class="line"></span><br><span class="line">estraverse.traverse(tree, &#123;</span><br><span class="line">    <span class="comment">// 只要遇到有type的情况才会进入</span></span><br><span class="line">    enter(node) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'enter'</span>, node.type);</span><br><span class="line">    &#125;,</span><br><span class="line">    leave(node) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'leave'</span>, node.type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">enter Program</span><br><span class="line">enter VariableDeclaration</span><br><span class="line">enter VariableDeclarator</span><br><span class="line">enter Identifier</span><br><span class="line">leave Identifier</span><br><span class="line">enter BinaryExpression</span><br><span class="line">enter Literal</span><br><span class="line">leave Literal</span><br><span class="line">enter Literal</span><br><span class="line">leave Literal</span><br><span class="line">leave BinaryExpression</span><br><span class="line">leave VariableDeclarator</span><br><span class="line">leave VariableDeclaration</span><br><span class="line">leave Program</span><br></pre></td></tr></table></figure></p>
<p>现在，知道了如何去生成及遍历 AST，包括<code>webpack</code>和<code>babel</code>的一些插件都可以对原有的 AST 进行修改，并生成带有新的特性或者移除多余特性的代码，那么在哪里才能进行对 AST 的修改呢？在上面的代码中，我们需要在 <code>enter(node)</code> 方法中对当前遍历到的<code>node</code>进行修改（毕竟node只是一个普通的对象），我们对其做如下修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将变量名字进行修改成新的变量名</span></span><br><span class="line"><span class="keyword">var</span> answer = <span class="number">6</span> * <span class="number">7</span>;</span><br><span class="line">=&gt;</span><br><span class="line"><span class="keyword">var</span> newAnswer = <span class="number">6</span> * <span class="number">7</span>;</span><br></pre></td></tr></table></figure>
<p>只需要在上节代码中的<code>enter(node)</code>方法中增加如下代码： </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(node.type === <span class="string">'VariableDeclarator'</span>) &#123;</span><br><span class="line">    node.id.name = <span class="string">'newAnswer'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">`  </span></span><br><span class="line"><span class="string">如图所示：</span></span><br><span class="line"><span class="string">![](Webpack-Tree-shaking-loader-的基本实现/AST.jpg)  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">我们修改的是红色标注部分。  </span></span><br><span class="line"><span class="string">修改完成之后，只需要使用`</span>escodegen<span class="string">`将修改过的`</span>AST<span class="string">`进行反向生成代码即可。 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>js</span><br><span class="line"><span class="keyword">let</span> escodegen = <span class="built_in">require</span>(<span class="string">'escodegen'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> r = escodegen.generate(tree);</span><br><span class="line"><span class="built_in">console</span>.log(r);</span><br></pre></td></tr></table></figure>
<p>我们就可以得到：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> newAnswer = <span class="number">6</span> * <span class="number">7</span>;</span><br></pre></td></tr></table></figure></p>
<p>了解了大致的生成 AST 和 修改 AST 以及再通过修改过的 AST 反向生成源代码后，实验几个小栗子。<br>接下来的<img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/lizi.png" width="20px" height="20px">小栗子中，我们会使用 <a href="https://github.com/babel/babel/tree/master/packages/babel-core" target="_blank" rel="noopener">babel-core</a> 和 <a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener">babel-types</a>。</p>
<h3 id="小栗子-ES6箭头函数转译为ES5普通函数"><a href="#小栗子-ES6箭头函数转译为ES5普通函数" class="headerlink" title="小栗子-ES6箭头函数转译为ES5普通函数"></a><img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/lizi.png" width="20px" height="20px">小栗子-<code>ES6</code>箭头函数转译为<code>ES5</code>普通函数</h3><p>在写代码之前，先使用 <a href="http://esprima.org/index.html" target="_blank" rel="noopener">esprima</a> 进行比较 <code>ES6</code> 箭头函数的 AST 与 <code>ES5</code> 普通函数 AST 之间的区别：</p>
<ul>
<li><p><code>ES6</code>的箭头函数 AST </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Program"</span>,</span><br><span class="line">    <span class="attr">"body"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"VariableDeclaration"</span>,</span><br><span class="line">            <span class="attr">"declarations"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"VariableDeclarator"</span>,</span><br><span class="line">                    <span class="attr">"id"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"sum"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"init"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"ArrowFunctionExpression"</span>,</span><br><span class="line">                        <span class="attr">"id"</span>: <span class="literal">null</span>,</span><br><span class="line">                        <span class="attr">"params"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"a"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"b"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        <span class="attr">"body"</span>: &#123;</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"BlockStatement"</span>,</span><br><span class="line">                            <span class="attr">"body"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"ReturnStatement"</span>,</span><br><span class="line">                                    <span class="attr">"argument"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="string">"BinaryExpression"</span>,</span><br><span class="line">                                        <span class="attr">"operator"</span>: <span class="string">"+"</span>,</span><br><span class="line">                                        <span class="attr">"left"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"a"</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"right"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"b"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"generator"</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">"expression"</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">"async"</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"let"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"sourceType"</span>: <span class="string">"script"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ES5</code>的相应函数的 AST </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">    &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Program"</span>,</span><br><span class="line">    <span class="attr">"body"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"VariableDeclaration"</span>,</span><br><span class="line">            <span class="attr">"declarations"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">"type"</span>: <span class="string">"VariableDeclarator"</span>,</span><br><span class="line">                    <span class="attr">"id"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                        <span class="attr">"name"</span>: <span class="string">"sum"</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"init"</span>: &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"FunctionExpression"</span>,</span><br><span class="line">                        <span class="attr">"id"</span>: <span class="literal">null</span>,</span><br><span class="line">                        <span class="attr">"params"</span>: [</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"a"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                <span class="attr">"name"</span>: <span class="string">"b"</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ],</span><br><span class="line">                        <span class="attr">"body"</span>: &#123;</span><br><span class="line">                            <span class="attr">"type"</span>: <span class="string">"BlockStatement"</span>,</span><br><span class="line">                            <span class="attr">"body"</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">"type"</span>: <span class="string">"ReturnStatement"</span>,</span><br><span class="line">                                    <span class="attr">"argument"</span>: &#123;</span><br><span class="line">                                        <span class="attr">"type"</span>: <span class="string">"BinaryExpression"</span>,</span><br><span class="line">                                        <span class="attr">"operator"</span>: <span class="string">"+"</span>,</span><br><span class="line">                                        <span class="attr">"left"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"a"</span></span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        <span class="attr">"right"</span>: &#123;</span><br><span class="line">                                            <span class="attr">"type"</span>: <span class="string">"Identifier"</span>,</span><br><span class="line">                                            <span class="attr">"name"</span>: <span class="string">"b"</span></span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">"generator"</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">"expression"</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">"async"</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"var"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"sourceType"</span>: <span class="string">"script"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>我们对比下这两个 AST （左边为 <code>ES5</code>的 AST， 右边为 <code>ES6</code> 的 AST）<br><img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/diff.jpg" alt=""></p>
<p>区别就在于箭头函数的声明和普通函数的声明上，其余内容一致，所以我们只需要做以下操作：  </p>
<ol>
<li>找到 <code>type</code> 为 <code>ArrowFunctionExpression</code> 的节点;</li>
<li>使用 <code>type</code> 为 <code>FunctionExpression</code> 的节点进行替换; </li>
<li>将 <code>ArrowFunctionExpression</code> 原有的 <code>body</code> 插入到 <code>FunctionExpression</code> 节点中;</li>
<li>重新生成源代码;</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'babel-core'</span>);</span><br><span class="line"><span class="keyword">let</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`let sum = (a, b) =&gt; a + b`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ArrowPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        <span class="comment">// path表示树的路径</span></span><br><span class="line">        <span class="comment">// 当前即为找到 ArrowFunctionExpression 的节点时会进行的操作</span></span><br><span class="line">        ArrowFunctionExpression(path) &#123;</span><br><span class="line">            <span class="comment">// 获取当前路径的节点</span></span><br><span class="line">            <span class="keyword">let</span> node = path.node;</span><br><span class="line">            <span class="comment">// 拿到当前节点的参数</span></span><br><span class="line">            <span class="keyword">let</span> params = node.params;</span><br><span class="line">            <span class="comment">// 拿到当前节点的body</span></span><br><span class="line">            <span class="keyword">let</span> body = node.body;</span><br><span class="line">            <span class="comment">// 直接生成一个函数声明</span></span><br><span class="line">            <span class="keyword">let</span> funcs = t.functionExpression(<span class="literal">null</span>, params, body, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="comment">// 替换当前的 node </span></span><br><span class="line">            path.replaceWith(funcs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// babel.transform 接收两个参数，第一个是需要转换的 AST,</span></span><br><span class="line"><span class="comment">// 第二个是 .babelrc 的配置</span></span><br><span class="line"><span class="keyword">let</span> r = babel.transform(code, &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        ArrowPlugin</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(r.code);</span><br><span class="line"><span class="comment">// 输出为:</span></span><br><span class="line"><span class="comment">// let sum = function (a, b) &#123;</span></span><br><span class="line"><span class="comment">//  return a + b;</span></span><br><span class="line"><span class="comment">// &#125;;</span></span><br></pre></td></tr></table></figure>
<h3 id="复杂的小栗子-class-的-ES5-转换"><a href="#复杂的小栗子-class-的-ES5-转换" class="headerlink" title="复杂的小栗子- class 的 ES5 转换"></a><img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/lizi.png" width="20px" height="20px">复杂的小栗子- <code>class</code> 的 <code>ES5</code> 转换</h3><p>这个例子与上述相似，不过稍微困难些，留下代码~ ε=ε=ε=┏(゜ロ゜;)┛逃</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'babel-core'</span>);</span><br><span class="line"><span class="keyword">let</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    function Test(name) &#123;</span></span><br><span class="line"><span class="comment">        this.name = name;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Test.prototype.getName = function() &#123;</span></span><br><span class="line"><span class="comment">        return this.name;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">let</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">class Test&#123;</span></span><br><span class="line"><span class="string">    constructor(name, gender) &#123;</span></span><br><span class="line"><span class="string">        this.name = name;</span></span><br><span class="line"><span class="string">        this.gender = gender;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    getName() &#123;</span></span><br><span class="line"><span class="string">        return this.name;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;`</span></span><br><span class="line"><span class="keyword">let</span> ClassPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        ClassDeclaration(path) &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123;node&#125; = path;</span><br><span class="line">            <span class="keyword">let</span> className = node.id.name;</span><br><span class="line">            <span class="keyword">let</span> classList = node.body.body;</span><br><span class="line"></span><br><span class="line">            className = t.identifier(className); <span class="comment">// 函数名字必须是一个标识符</span></span><br><span class="line">            <span class="keyword">let</span> funcs = t.functionDeclaration(className, [], t.blockStatement([]), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            path.replaceWith(funcs);</span><br><span class="line">            <span class="keyword">let</span> es5Func = [];</span><br><span class="line"></span><br><span class="line">            classList.forEach(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> body = classList[index].body;</span><br><span class="line">                <span class="keyword">if</span> (item.kind === <span class="string">'constructor'</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果是构造函数那就生成新的函数将默认的空函数替换掉</span></span><br><span class="line">                    <span class="keyword">let</span> params = item.params.length ? item.params.map(<span class="function"><span class="params">item</span> =&gt;</span> item.name) : [];</span><br><span class="line">                    params = t.identifier(params);</span><br><span class="line">                    funcs = t.functionDeclaration(className, [params], body, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 其他情况就是原型的方法</span></span><br><span class="line">                    <span class="keyword">let</span> protoObj = t.memberExpression(className, t.identifier(<span class="string">'prototype'</span>));</span><br><span class="line">                    <span class="keyword">let</span> left = t.memberExpression(protoObj, t.identifier(item.key.name));</span><br><span class="line">                    <span class="keyword">let</span> right = t.functionExpression(<span class="literal">null</span>, [], body, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">let</span> assign = t.assignmentExpression(<span class="string">'='</span>, left, right);</span><br><span class="line">                    <span class="comment">// 多个原型上的方法</span></span><br><span class="line">                    es5Func.push(assign);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">if</span> (es5Func.length == <span class="number">0</span>) &#123;</span><br><span class="line">                path.replaceWith(funcs);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                es5Func.unshift(funcs);</span><br><span class="line">                <span class="comment">// 替换n个节点</span></span><br><span class="line">                path.replaceWithMultiple(es5Func);</span><br><span class="line">                <span class="comment">// 有原型上的方法</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> r = babel.transform(code, &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        ClassPlugin</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(r.code);</span><br></pre></td></tr></table></figure>
<h3 id="正文开始——-shaking"><a href="#正文开始——-shaking" class="headerlink" title="正文开始—— shaking"></a>正文开始—— shaking</h3><p>先看我们需要 shaking 的代码是什么。<br>都用过 [antd] 就不再赘述，也知道在 [antd] 中，我们一般都会这么使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Button, Alert &#125; <span class="keyword">from</span> <span class="string">'antd'</span>;</span><br></pre></td></tr></table></figure>
<p>使用解构赋值的方法能很方便我们引入，但是 [webpack] 在打包的时候不会关心你到底引入了什么，所以会一股脑儿的把 [antd] 打包进入到你的生产环境 js (也就是 bundle) 中，这样使得我们的 bundle 体积会很大，但是按需引入的方法就解决了这个问题，代码如下：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'antd/lib/button'</span>;</span><br><span class="line"><span class="keyword">import</span> Alert <span class="keyword">from</span> <span class="string">'antd/lib/button'</span>;</span><br></pre></td></tr></table></figure>
<p>现在要做的就是通过 shaking-loader 把上面的解构赋值代码直接转换为下面的按需引入的代码，这样既方便了我们开发引入，也使得 bundle 体积会成倍的减小以及提高打包时间。  </p>
<p>原理与第一个小栗子是一致的，放出前后 AST 的对比图：</p>
<p><img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/diff-antd.jpg" alt=""> </p>
<p>我们可以对比前后两个 AST 的不同之处，这样根据不同的地方进行中间的修改即可，放出代码：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现模块的按需加载</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// import &#123;Button&#125; from 'antd';</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// babel-plugin-import </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// import &#123;Button, Alert&#125; from 'antd';</span></span><br><span class="line"><span class="comment">// =&gt;</span></span><br><span class="line"><span class="comment">// import Button from 'antd/lib/button';</span></span><br><span class="line"><span class="comment">// import Alert from 'antd/lib/button';</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> babel = <span class="built_in">require</span>(<span class="string">'babel-core'</span>);</span><br><span class="line"><span class="keyword">let</span> t = <span class="built_in">require</span>(<span class="string">'babel-types'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// let code = `import &#123;Button, Alert&#125; from 'antd'`;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> importPlugin = &#123;</span><br><span class="line">    visitor: &#123;</span><br><span class="line">        ImportDeclaration(path) &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123;node&#125; = path;</span><br><span class="line">            <span class="keyword">let</span> source = node.source.value;</span><br><span class="line">            <span class="keyword">let</span> specifiers = node.specifiers;</span><br><span class="line">            <span class="keyword">if</span> (!t.isImportDefaultSpecifier(specifiers[<span class="number">0</span>])) &#123;</span><br><span class="line">                <span class="comment">// 遍历原有的specifiers，进行处理修改</span></span><br><span class="line">                specifiers = specifiers.map(<span class="function"><span class="params">specifier</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> t.importDeclaration(</span><br><span class="line">                        [t.importDefaultSpecifier(specifier.local)],</span><br><span class="line">                        t.stringLiteral(<span class="string">`<span class="subst">$&#123;source&#125;</span>/lib/<span class="subst">$&#123;specifier.local.name.toLowerCase()&#125;</span>`</span>)</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// 批量替换</span></span><br><span class="line">                path.replaceWithMultiple(specifiers);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let r = babel.transform(code, &#123;</span></span><br><span class="line"><span class="comment">//     plugins: [</span></span><br><span class="line"><span class="comment">//         importPlugin</span></span><br><span class="line"><span class="comment">//     ]</span></span><br><span class="line"><span class="comment">// &#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log(r.code);</span></span><br><span class="line"><span class="built_in">module</span>.exports = importPlugin;</span><br></pre></td></tr></table></figure>
<p>其实，上述代码理解起来并不难，前期只要理解了 <a href="https://github.com/babel/babel/tree/master/packages/babel-core" target="_blank" rel="noopener">babel-core</a> 和 <a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener">babel-types</a> 的 API，即可写出自己需要的 loader 或 AST 处理器。  </p>
<p>OK，正文很少，我们看下经过 shaking 之后与没有 shaking 的打包速度和大小对比吧:</p>
<p><img src="/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/shaking.jpg" alt="">  </p>
<p>WOW！相对比，shaking 之后，打包时间提升了近 6 倍，打包的体积更是之前的 1/10 ！  </p>
<p>累了累了，滚去睡觉~~~</p>
<blockquote>
<p>转推一篇文章 <a href="https://zhuanlan.zhihu.com/p/34191831" target="_blank" rel="noopener">微信小程序也要强行热更代码，鹅厂不服你来肛我呀</a><br>果然，懂编译原理的人是可以为所欲为的~  </p>
</blockquote>

	
	
	
	
</div>
				
				

                <!-- Post Comments -->
                
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #0097A7 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #0097A7 !important;
    }
    #ds-reset .ds-highlight {
        color: #0097A7 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
        <div class="ds-thread" 
            data-thread-key="2018/07/12/Webpack-Tree-shaking-loader-的基本实现/" 
            data-url="https://jackerjay.github.io/2018/07/12/Webpack-Tree-shaking-loader-的基本实现/"
            data-title="Webpack Tree-shaking-loader 的基本实现"></div>
    <!-- 多说评论框 end -->
</div>



            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    
    <!-- Prev Nav -->
    
        <a href="/2018/07/13/你不知道的JS上卷记录/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/07/10/JavaScript-高级程序设计-知识点/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>
        </div>
    </div>

				
				
					<!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay "></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored  sidebar-fixed-left" role="navigation">
	<div id="sidebar-main">
	    <!-- Sidebar Header -->
		<div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
    <i class="material-icons">clear_all</i>
    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="JackerJay's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jackerjay@hotmail.com
        <b class="caret"></b>
    </a>
</div>

		<!-- Sidebar Navigation  -->
		<ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
			
                <li>
                    <a href="#" target="_blank" title="Email Me">
						<i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    <li id="sidebar-first-li">
        <a href="/" target="_self">
            <i class="material-icons sidebar-material-icons">home</i>
             主页
        </a>
    </li>

    <!-- I'm Feeling Lucky -->
<!--
    <li class="dropdown">
        <a href="" target="_self">
            <i class="material-icons sidebar-material-icons">explore</i>
             sidebar.imlucky
        </a>
    </li>
-->

	
    <!-- Archives  -->
    <li class="dropdown">
        <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
            <i class="material-icons sidebar-material-icons">inbox</i>
             归档
            <b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
            <li>
            <a class="sidebar_archives-link" href="/archives/2019/03/">三月 2019<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/05/">五月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">三月 2017<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">二月 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">十二月 2016<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/11/">十一月 2016<span class="sidebar_archives-count">4</span></a>
        </ul>
    </li>

    <!-- Divider -->
    <li class="divider"></li>


    <!-- Pages  -->
	

    <!-- Article Numebr  -->
    <li>
        <a href="/archives">
             文章总数
             <span class="sidebar-badge">26</span>
        </a>
    </li>
</ul>

		<!-- Sidebar Divider -->
		<div class="sidebar-divider"></div>

		<!-- Sidebar Footer -->
		<!-- 
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持。 :) 
-->

<!-- Theme Material -->
<a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
	<div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		主题 - Material
		<span class="sidebar-badge badge-circle">i</span>
	</div>
</a>

<!-- Help & Support -->
<!--
<a href="mailto:hiviosey@gmail.com" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
		sidebar.help
		<span class="mdl-button__ripple-container">
			<span class="mdl-ripple"></span>
		</span>
	</div>
</a>
-->

<!-- Feedback -->
<!--
<a href="https://github.com/viosey/hexo-theme-material/issues" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.feedback
                    <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>
-->

<!-- Abount Theme -->
<!--
<a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
    <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
         sidebar.about_theme
        <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
</a>-->

	</div>
    
    <!-- Sidebar Sponsor -->
    


</aside>

				
				
				
					<!-- Footer Top Button -->
					<div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>
				
				
				<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
	
	
		<!-- Paradox Footer Left Section -->
		<div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
    
    
    <!-- Facebook -->
    
    
    
    <!-- Google + -->
    
    
    
    <!-- Weibo -->
    
    
    
    <!-- Instagram -->
    
    
    
    <!-- Tumblr -->
    
    
    
    <!-- Github -->
    
    <a href="http://github.com/jackerjay" target="view_window"><button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.png);">
        <span class="visuallyhidden">Github</span>
    </button></a>
    
</div>


		<!--Copyright-->
		<div id="copyright">Copyright&nbsp;©&nbsp;<script type="text/javascript">var fd = new Date();document.write(fd.getFullYear());</script>&nbsp;JackerJay杂记</div>

		<!-- Paradox Footer Right Section -->

		<!-- 
		I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
		It will not impact the appearance and can give developers a lot of support :)

		很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
		它不会影响美观并可以给开发者很大的支持。 :) 
		-->

		<div class="mdl-mini-footer--right-section">
			<div>
				<div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
				<div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
			</div>
		</div>
	
    
</footer>
                
				<!-- Import File -->
<script src="/js/highlight.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    
    $('#nprogress .bar').css({
        'background': '#FF4081'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #FF4081, 0 0 15px #FF4081'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#FF4081',
        'border-left-color': '#FF4081'
    });
    
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>








    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"null"};
        (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = 'https://static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
    </script>
    <!-- 多说公共 js 代码 end -->




<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $(".post-toc-wrap").parent(".mdl-menu__container").css("position", "fixed");
    });
</script>

<!-- MathJax Load-->

            </main>
        </div>
		
    </body>
		
	
</html>
